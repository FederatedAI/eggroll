# 脚本使用说明

## 一 概述

本工具集提供4个工具，功能如下：

| 工具名称         | 工具功能                                   | 使用场景         |
| ---------------- | ------------------------------------------ | ---------------- |
| 机器基础信息检测 | 验证机器设置是否满足跑fate任务要求         | 部署完fate后     |
| fate运行信息检测 | 验证机器当前状态是否适合新建一个fate任务   | 启动fate任务前   |
| 日志搜集         | 搜集该集群下所有session_id的日志到当前目录 | 跑任务出现错误后 |
| 集群配置检测     | 搜集展示集群的配置文件信息                 | 跑任务出现错误后 |



## 二 机器基础信息检测

### 2.1 使用场景

此脚本在部署完fate后运行，脚本功能检查系统内存 / 虚拟内存 / 磁盘 / 最大用户进程数 / 文件数 / 线程数设置 / rollsite进程堆内存 等机器基础信息，用于验证机器设置是否满足跑fate任务要求。

### 2.2 工具功能

1）检查系统内存：系统内存总量、系统内存使用量、系统内存使用占比

2）检查虚拟内存：虚拟内存总量、虚拟内存使用量、虚拟内存使用占比

3）检查磁盘使用情况：磁盘总量、磁盘使用量、磁盘使用占比 

4）检查系统最大用户进程数：检查内容包括以下文件

```shell
cat /proc/sys/kernel/threads-max
cat /etc/sysctl.conf
cat /proc/sys/kernel/pid_max
cat /proc/sys/vm/max_map_count
```

5）检查最大文件数：检查内容包括以下文件

```shell
cat /etc/security/limits.conf
cat /etc/security/limits.d/80-nofile.conf
cat /etc/sysctl.conf 
cat /proc/sys/fs/file-max
```

6）检查线程数设置：检查egg pair线程数eggroll.rollpair.eggpair.server.executor.pool.max.size设置是否充足

检查方法：

```properties
P = pstree -p ps -e |grep egg_pair |awk '{print $1}' |wc -l（统计服务器所有egg pair进程所用线程数）

n = eggroll.session.processors.per.node(默认16)

r = eggroll.rollpair.eggpair.server.executor.pool.max.size(默认值500)

M =  n * r  

若所得线程数P<M，则视为线程数设置充足，若P≥M，则提示eggroll.rollpair.eggpair.server.executor.pool.max.size应调高。
```

7）检查rollsite进程堆内存是否充足：

检查方法：

```shell
通过 ps aux | grep ${EGGROLL_HOME} | grep com.webank.eggroll.rollsite.Proxy | grep -v grep | awk '{print $2}' 得到rollsite进程的pid
若pid不存在，则不返回信息；
若pid存在，则将其进程占用内存输出，并与rollsite设置最大使用内存按占用内存/设置最大内存作百分比。(最大内存默认值为系统内存的1/4)
最终rollsite内存占用百分比返回，作黄色提醒信息
```

### 2.3 使用方法

先source init_env.sh ，init_env.sh位于部署目录下，设置环境变量等关键信息，然后执行：

```shell
cd $EGGROLL_HOME/bin/debug
sh env_check.sh ${集群节点个数}
//查看检测结果
cat result_env.log
```

### 2.4 检测结果说明

返回示例信息如下：

[^说明：以下信息分为三种提示等级：]: 
[^[OK\] 表示该检查项正常；]: 
[^[WARNING\]表示该项需要注意，仅作关键信息展示，需要自行判断；]: 
[^[ERROR\]表示该项不符合预期结果，需要按提示修改。]: 

```properties
//脚本执行时间
        2020-09-02 15:00:41.424053
//返回的节点ip
        ==============This is node 0:127.0.0.1===========================================
//系统内存总量、系统内存使用量、系统内存使用占比
        [WARNING] MemTotal:78.51G, MemUsed:11.5G, MemUsedPCT:15%
//虚拟内存总量、虚拟内存使用量、虚拟内存使用占比，若小于128G，则提示ERROR，如下所示：
        [ERROR] The swap memory is:32.0G, no less than 128G.		<虚拟内存不足
        [WARNING] MemTotal:16.51G, MemUsed:128G, MemUsedPCT:12.3%	<虚拟内存正常
//磁盘总量、磁盘使用量、磁盘使用占比 
        [WARNING] DiskTotal:984.18G, DiskUsed:566.53G, DiskUsedPCT:61%
        --------------Max user processes and max file count------------------------------
//最大用户进程数与最大文件数各个文件设置值展示，其中不满足65535的项则报[ERROR提示]：
        [OK] /proc/sys/kernel/threads-max = 642956
        [OK] /etc/sysctl.conf = 1048576
        [OK] /proc/sys/kernel/pid_max = 131072
        [ERROR] please check /proc/sys/vm/max_map_count = 65530, no less than 65535.
        [OK] /etc/security/limits.conf = 102401
        [OK] /etc/security/limits.d/80-nofile.conf = 131072
        [OK] /etc/sysctl.conf = 1048576
        [OK] /proc/sys/fs/file-max = 1048576
        --------------Thread count check-------------------------------------------------
//判断eggroll.properties中eggroll.rollpair.eggpair.server.executor.pool.max.size配置项设置的线程值是否充足，若不充足，则报[ERROR]提示需要调大线程值
        [OK] The thread count = 1406, the total processes = 16 * 500 = 8000
        ----------Rollsite memory use percent--------------------------------------------
//展示rollsite进程占用堆内存与rollsite设置内存上限比值，以判断rollsite内存是否充足，若百分比偏大，则需考虑释放rollsite内存或调高rollsite内存上限
        [WARNING] rollsite memory use: 0.69%
```



## 三 fate运行信息检测

### 3.1 使用场景

跑fate任务前，检测fate运行信息。验证机器当前状态是否适合新建一个fate任务

### 3.2 工具功能

1）检测机器基础信息：系统内存 / 虚拟内存 / 磁盘 / 最大用户进程数 / 文件数/线程数设置/rollsite进程堆内存 

2）检测fate运行信息：eggroll路由是不是默认路由/是否已安装data access/fate服务状态、进程数及占用内存/当前环境正在运行及等待的job任务数、job任务有多少进程及占用的内存 。

### 3.3 使用方法

source $EGGROLL_HOME/init.sh	导入环境变量

export EGGROLL_LOG_LEVEL=INFO	修改日志输出INFO模式

python server_ckeck.py -p {集群内节点个数} -t {检测间隔秒数，不填只检测一次}

### 3.4 检测结果说明

![1599015506806](C:\Users\v_wbxzheng\AppData\Roaming\Typora\typora-user-images\1599015506806.png)

#### 3.4.1 default route check(eggroll路由是不是默认路由)

- 检测通过提示：

  [OK] eggroll route configured!

  "port": 9801, "ip": "172.16.153.25" "port": 9810, "ip": "172.16.153.25" "port": 9801, "ip": "172.16.153.95"

- 检测失败提示：

   [ERROR] eggroll route is not configured, please check data/projects/fate/eggroll/conf/route_table.json file if it is existed!

- 检查方法：

  if [ -f $EGGROLL_HOME/conf/route_table.json ];then array=(`cat $EGGROLL_HOME/conf/route_table.json |grep -E 'ip|port'`); echo ${array[@]}; else echo 0; fi

  若返回值为0，则视为未配置eggroll route，提示ERROR：没有设置eggroll route。

#### 3.4.2 data_access service check(是否已安装data access)

- 检测通过提示：

  [OK] Installed and running data_access service!

- 检测失败提示：

  [ERROR] data_access service and directory not found, please check if it is installed!

- 检查方法：

  ps aux |grep data_access_server |grep -v grep |wc -l	//获取data_access进程数

  if [ -d /data/projects/fdn/FDN-DataAcces ];then echo 1; else echo 0; fi		//检查服务目录

  若返回进程数为0，判断检查服务目录的返回值，若为0，则视为没有安装access，提示ERROR；否则，则视为没有启动access，提示WARNING。
  
#### 3.4.3 fate service check(fate服务状态、进程数及占用内存)

- 检测通过提醒：

  [OK] the service is running , number of processes is ：; used memory：

- 检测失败提醒：

  [WARNING] the service not running, please check service status.

- 检查方法：

  services = ['ClusterManagerBootstrap','NodeManagerBootstrap','rollsite','fate_flow_server.py','fateboard','mysql']	//fate服务列表

  for service in services：

  ​	thread = ps -ef |grep service |grep -v grep |wc -l	//获取服务进程数

  ​	server_mem = ps aux |grep %s |grep -v grep |awk '{sum+=$6};END {print sum}'	//获取服务占用内存

  判断thread值，若大于0，则服务正在运行，展示进程数及占用内存；否则，视为服务未启动。
#### 3.4.4 fate_flow jobs process and mem info check(job任务数检测、job任务进程及占用内存)
- 检测通过提醒：

  [OK] Number of tasks running is
  
  [OK] Number of tasks waiting is
  
  [OK] running task job_id ： ，number of processes is ：; used memory：
  
- 检测失败提醒：

  [ERROR] There is no such fate_flow_client.py file, please check fate_flow server if it is running!
  
- 检查方法：

  fate_flow_client = "/data/projects/fate/python/fate_flow/fate_flow_client.py"
  
  job_run = if [ -f $fate_flow_client ];then python $fate_flow_client -f query_job -s running | grep f_job_id |wc -l; else echo -1; fi	//获取running job任务数
  
  job_wait = if [ -f $fate_flow_client  ];then python $fate_flow_client  -f query_job -s waiting | grep f_job_id |wc -l; else echo -1; fi	//获取waiting job任务数
  
  jobs = python $fate_flow_client -f query_job -s running | grep f_job_id |awk -F: '{print $2}' |awk -F '\"' '{print $2}'`);echo ${array[@]}	//获取running状态job任务的job_id
  
  for job_id in jobs:
  
  ​	job_thread = ps -ef |grep egg_pair |grep -v grep |grep job_id  |wc -l	//获取job任务的进程数
  
  ​	job_mem = ps aux |grep egg_pair |grep job_id  |awk '{sum+=$6};END {print sum}'	//获取job任务的占用内存
  
  判断：若job_run为-1，则提示ERROR，找不到fate_flow客户端文件，确认fate_flow是否运行；否则，依此展示job任务数以及job任务的进程数和占用内存。
  
  

## 四 日志搜集

### 4.1 使用场景

适用于出现错误后，在开发人员指导下进行错误日志搜集脚本，需要从报错日志中提取关键报错信息。

### 4.2 工具功能

拉取指定ip：$EGGROLL_HOME/logs目录下带传入关键字的目录到本机当前目录下

### 4.3 使用方法

先source init_env.sh ，init_env.sh位于部署目录下，设置环境变量等关键信息，配置需要拉取的ip信息：

```shell
cd $EGGROLL_HOME/bin/debug

<配置iplist以及EGGROLL_HOME>
vi check_iplist.sh
user=app							   						<远程登录用户名>
iplist=(127.0.0.1 127.0.0.2 127.0.0.3)					   <需要拉取日志的ip列表>
```

然后执行拉取脚本：

```shell
sh grep_logs.sh ${需要查询的session_id} <带上需要搜集的session_id，支持模糊查询>

<执行后该session_id的各个ip的日志便会搜集到当前目录下的$session_id/$ip目录下>
```

### 4.4 结果说明

执行完可在当前目录下看到传入的$session_id目录，目录下是各个ip的关于$session_id的日志。

## 五 集群配置检测

### 5.1 使用场景

适用于运维人员部署好项目后，肉眼检查各个机器的eggroll.properties、route_table.json配置是否存在问题。

### 5.2 工具功能

拉取指定ip的eggroll.properties、route_table.json配置到本机展示。

### 5.3 使用方法

先source init_env.sh ，init_env.sh位于部署目录下，设置环境变量等关键信息，配置需要拉取的ip信息：

```shell
cd $EGGROLL_HOME/bin/debug

<配置iplist以及EGGROLL_HOME>
vi check_iplist.sh
user=app							   						<远程登录用户名>
iplist=(127.0.0.1 127.0.0.2 127.0.0.3)					   <需要拉取日志的ip列表>
```

然后执行脚本：

```shell
sh check_conf.sh
```

### 5.4 结果说明

该脚本展示配置所有ip与本机的配置对比，说明如下：

```properties
//展示本机eggroll.properties配置信息
----------------------$EGGROLL_HOME/conf/eggroll.properties--------------------
//展示本机route_table.json配置信息
-----------------------$EGGROLL_HOME/conf/route_table.json---------------------
//展示ip列表中第一个ip配置与本机的diff结果，若为空则完全相同
------------------diff $ip1 with ./conf/eggroll.properties-------------------------
//展示ip列表中第二个ip配置与本机的diff结果，若为空则完全相同
------------------diff $ip2 with ./conf/eggroll.properties-------------------------
//展示ip列表中第三个ip配置与本机的diff结果，若为空则完全相同
------------------diff $ip3 with ./conf/eggroll.properties-------------------------
```

